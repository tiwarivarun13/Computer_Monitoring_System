<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>System Monitor Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f4f9;
  }

  .navbar {
    background: #2c3e50;
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .navbar h1 {
    margin: 0;
    font-size: 20px;
  }

  .navbar .nav-links button {
    margin-left: 10px;
    padding: 6px 12px;
    border: none;
    background: #34495e;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }

  .navbar .nav-links button.active {
    background: #1abc9c;
  }

  .container {
    padding: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    text-align: left;
  }

  tr.child-row {
    display: none;
    background: #ffccaaff;
  }

  .toggle-content {
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 15px;
    border-radius: 8px;
  }

  a {
    cursor: pointer;
    color: #3498db;
    text-decoration: underline;
    margin-right: 10px;
  }

  button.toggle-btn {
    padding: 2px 6px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="navbar">
  <h1>System Monitor Dashboard</h1>
</div>

<div class="container">
  <table id="hosts-table">
    <thead>
      <tr>
        <th>Hostname</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="hosts-body"></tbody>
  </table>
</div>

<script>
const API_BASE = "http://127.0.0.1:8000/api";

async function loadHosts() {
  try {
    const res = await fetch(`${API_BASE}/hosts/`);
    const hosts = await res.json();
    const tbody = document.getElementById("hosts-body");
    tbody.innerHTML = "";

    hosts.forEach(host => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${host.hostname}</td>
        <td>
          <a onclick="toggleSystemInfo(this, ${host.id})">System Info</a>
          <a onclick="toggleProcesses(this, ${host.id})">Process Details</a>
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch (err) {
    console.error("Error loading hosts:", err);
  }
}

async function toggleSystemInfo(link, hostId) {
  const tr = link.closest("tr");
  let nextRow = tr.nextElementSibling;

  if(nextRow && nextRow.dataset.type === "system") {
    nextRow.remove();
    return;
  }

  if(nextRow && (nextRow.dataset.type === "system" || nextRow.dataset.type === "process")) {
    nextRow.remove();
  }

  const res = await fetch(`${API_BASE}/hosts/${hostId}/`);
  const host = await res.json();

  const infoRow = document.createElement("tr");
  infoRow.dataset.type = "system";
  const td = document.createElement("td");
  td.colSpan = 2;
  td.classList.add("toggle-content");
  td.innerHTML = `
    <h3>System Information: ${host.hostname}</h3>
    <table>
      <tr><th>OS</th><td>${host.operating_system}</td></tr>
      <tr><th>Processor</th><td>${host.processor}</td></tr>
      <tr><th>Cores</th><td>${host.num_cores}</td></tr>
      <tr><th>Threads</th><td>${host.num_threads}</td></tr>
      <tr><th>RAM Total</th><td>${(host.ram_total/1024/1024/1024).toFixed(2)} GB</td></tr>
      <tr><th>RAM Used</th><td>${(host.ram_used/1024/1024/1024).toFixed(2)} GB</td></tr>
      <tr><th>RAM Available</th><td>${(host.ram_available/1024/1024/1024).toFixed(2)} GB</td></tr>
      <tr><th>Storage Total</th><td>${(host.storage_total/1024/1024/1024).toFixed(2)} GB</td></tr>
      <tr><th>Storage Used</th><td>${(host.storage_used/1024/1024/1024).toFixed(2)} GB</td></tr>
      <tr><th>Storage Free</th><td>${(host.storage_free/1024/1024/1024).toFixed(2)} GB</td></tr>
    </table>
  `;
  infoRow.appendChild(td);
  tr.parentNode.insertBefore(infoRow, tr.nextElementSibling);
}

async function toggleProcesses(link, hostId) {
  const tr = link.closest("tr");
  let nextRow = tr.nextElementSibling;

  if(nextRow && nextRow.dataset.type === "process") {
    nextRow.remove();
    return;
  }

  if(nextRow && (nextRow.dataset.type === "system" || nextRow.dataset.type === "process")) {
    nextRow.remove();
  }

  const res = await fetch(`${API_BASE}/hosts/${hostId}/processes/`);
  const data = await res.json();
  const processes = data.processes;

  const infoRow = document.createElement("tr");
  infoRow.dataset.type = "process";
  const td = document.createElement("td");
  td.colSpan = 2;
  td.classList.add("toggle-content");

  td.innerHTML = `
    <h3>Processes: ${data.host.hostname}</h3>
    <table>
      <thead>
        <tr><th></th><th>PID</th><th>Name</th><th>CPU %</th><th>Memory MB</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  `;

  const tbody = td.querySelector("tbody");
  processes.forEach(proc => addProcessRow(proc, tbody));

  infoRow.appendChild(td);
  tr.parentNode.insertBefore(infoRow, tr.nextElementSibling);
}

function addProcessRow(proc, tbody, parentPid=null, level=0) {
  const row = document.createElement("tr");
  row.dataset.pid = proc.pid;
  row.dataset.parent = parentPid || "";
  if(parentPid) row.classList.add("child-row");

  let toggleBtn = "";
  if(proc.children && proc.children.length > 0) {
    toggleBtn = `<button class="toggle-btn" onclick="toggleChildren(${proc.pid}, this)">+</button>`;
  }

  row.innerHTML = `
    <td>${toggleBtn}</td>
    <td>${proc.pid}</td>
    <td style="padding-left:${level*20}px">${proc.name}</td>
    <td>${proc.cpu_usage || 0}</td>
    <td>${proc.memory_usage || 0}</td>
  `;

  tbody.appendChild(row);

  if(proc.children) {
    proc.children.forEach(child => addProcessRow(child, tbody, proc.pid, level+1));
  }
}

function toggleChildren(pid, btn, forceCollapse=false) {
  const rows = document.querySelectorAll(`tr[data-parent='${pid}']`);
  const show = forceCollapse ? false : btn.textContent === "+";
  btn.textContent = show ? "âˆ’" : "+";

  rows.forEach(r => {
    if(show) r.style.display = "table-row";
    else {
      r.style.display = "none";
      const childBtn = r.querySelector(".toggle-btn");
      if(childBtn) childBtn.textContent = "+";
      toggleChildren(r.dataset.pid, {textContent:"+"}, true);
    }
  });
}

loadHosts();
</script>

</body>
</html>
